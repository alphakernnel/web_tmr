<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Total Music Radio (PC)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.158.0/three.min.js"></script>
  <style>
    /* Fuentes para un estilo rock/metal moderno */
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden; /* Esto oculta el scroll de la página */
      background: #121212; /* Fondo negro intenso */
      color: #f44336; /* Rojo intenso como color primario */
      font-family: 'Montserrat', sans-serif; /* Fuente moderna y legible para el cuerpo */
    }

    /* Estilos para el contenedor de estrellas (fondo) */
    #starfield-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1; /* Asegura que esté en el fondo */
      opacity: 0.8; /* Ligeramente transparente */
    }

    .header {
      display: none; /* Oculta el encabezado HTML si lo hubiera */
    }

    /* Estilos para el logo de la radio */
    #radioLogo {
      position: absolute;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 300px;
      height: auto;
      z-index: 3;
      filter: drop-shadow(0 0 10px rgba(255, 152, 0, 0.7));
      cursor: pointer;
      transition: transform 0.2s ease-out, filter 0.3s ease;
    }

    #radioLogo.playing {
      animation: pulseLogo 1.5s infinite alternate; /* Animación de pulsación */
    }

    @keyframes pulseLogo {
        from { transform: translateX(-50%) scale(1); filter: drop-shadow(0 0 10px rgba(255, 152, 0, 0.7)); }
        to { transform: translateX(-50%) scale(1.08); filter: drop-shadow(0 0 25px rgba(255, 152, 0, 1)); }
    }

    /* Mensaje de inicio para PC - Ajustado para centrado vertical y mejor visibilidad */
    #initialMessage {
        position: absolute;
        top: 50%; /* Centrado vertical */
        left: 50%;
        transform: translate(-50%, -50%); /* Ajuste para centrado real */
        color: #fff;
        font-size: 1.2em;
        text-align: center;
        width: 90%;
        max-width: 400px;
        background-color: rgba(0,0,0,0.6);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        z-index: 4;
        font-family: 'Roboto Condensed', sans-serif;
    }

    #trackInfo {
      position: absolute;
      top: 70%; /* Posición de la información de la canción - AJUSTADO PARA NO INTERFERIR */
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7); /* Fondo semi-transparente */
      border: 1px solid #ff9800; /* Borde naranja */
      box-shadow: 0 0 15px rgba(255, 152, 0, 0.7); /* Sombra naranja brillante */
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.2em;
      text-align: center;
      min-width: 300px;
      max-width: 80%;
      box-sizing: border-box;
      z-index: 3;
      color: #fff;
      text-shadow: 0 0 5px #ff9800; /* Sombra de texto para resaltar */
      font-family: 'Montserrat', sans-serif;
    }

    .bottom-ui {
      position: absolute;
      bottom: 80px; /* Ajustado para dejar espacio a las redes sociales */
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px; /* Espacio entre los grupos de elementos */
      z-index: 2;
      width: 90%;
      box-sizing: border-box;
    }

    .controls {
      display: flex;
      gap: 12px; /* Espacio entre los botones - REDUCIDO */
      flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas pequeñas */
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.7); /* Fondo semi-transparente para la botonera */
      padding: 10px 20px; /* Padding de la botonera - REDUCIDO */
      border-radius: 12px;
      border: 1px solid #616161;
      box-shadow: 0 0 15px rgba(97, 97, 97, 0.4);
    }

    .controls button {
      padding: 6px 10px; /* Más padding para hacerlos "gordos" - REDUCIDO un 60% aprox. */
      font-size: 0.8em; /* Íconos más pequeños - REDUCIDO un 60% aprox. */
      background-color: #f44336;
      color: #fff;
      border: 2px solid #d32f2f;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Roboto Condensed', sans-serif;
      font-weight: 700;
      box-shadow: 0 0 8px rgba(244, 67, 54, 0.6);
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
      flex-shrink: 0;
      display: flex; /* Para centrar el icono */
      align-items: center;
      justify-content: center;
      min-width: 40px; /* Asegura un tamaño mínimo si el padding es muy bajo */
      min-height: 40px;
    }

    .controls button:hover {
      background-color: #d32f2f;
      box-shadow: 0 0 15px rgba(211, 47, 47, 0.8);
      transform: translateY(-2px); /* Pequeño efecto al pasar el ratón */
    }

    /* Estilo específico para el botón de refrescar y pantalla completa */
    .controls #refreshButton,
    .controls #fullscreenButton {
      font-size: 0.7em; /* Ligeramente más pequeños si lo deseas - AJUSTADO */
      padding: 6px 8px; /* AJUSTADO */
    }

    /* Estilos para el control de volumen */
    .volume-control-group {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid #616161;
      box-shadow: 0 0 10px rgba(97, 97, 97, 0.4);
      margin-top: 15px; /* Separación de los botones de control */
    }

    .volume-control-group i {
      color: #fff;
      font-size: 1.2em; /* Tamaño del icono de volumen - Ligeramente reducido para concordar */
      text-shadow: 0 0 5px #ff9800;
    }

    #volumeControl {
      width: 150px;
      -webkit-appearance: none; /* Elimina estilos por defecto del navegador */
      appearance: none;
      height: 8px;
      background: #555; /* Fondo del deslizador */
      outline: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #volumeControl::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #ff9800; /* Naranja brillante para el thumb */
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(255, 152, 0, 0.8); /* Sombra para el thumb */
    }

    #volumeControl::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #ff9800;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(255, 152, 0, 0.8);
    }

    /* Estilos para las redes sociales */
    .social-links {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 4;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid #616161;
      box-shadow: 0 0 10px rgba(97, 97, 97, 0.4);
      flex-wrap: wrap;
      justify-content: center;
      width: 90%;
      box-sizing: border-box;
      max-width: 450px;
    }

    .social-links a {
      color: #fff;
      font-size: 2.2em;
      transition: color 0.3s, transform 0.3s;
      text-decoration: none;
    }

    .social-links a:hover {
      color: #ff9800;
      transform: scale(1.2);
    }

    /* Estilos específicos para algunos iconos con sus colores de marca */
    .social-links .fa-instagram:hover { color: #E1306C; }
    .social-links .fa-facebook:hover { color: #3b5998; }
    .social-links .fa-whatsapp:hover { color: #25D366; }
    .social-links .fa-coffee:hover { color: #FFDD00; }
  </style>
</head>
<body>
  <div id="starfield-container"></div>

  <img id="radioLogo" src="https://github.com/alphakernnel/web_tmr/blob/main/logo_tmr.png?raw=true" alt="Logo Total Music Radio">

  <div id="initialMessage">Haz clic en 'Iniciar Radio' para comenzar</div>

  <div id="trackInfo" style="display:none;"></div>

  <div class="bottom-ui">
    <div class="controls" id="controlPanel">
      <button id="playButton"><i class="fas fa-play"></i></button>
      <button id="stopButton" style="display:none"><i class="fas fa-stop"></i></button>
      
      <button id="refreshButton" title="Recargar la conexión"><i class="fas fa-sync-alt"></i></button>
      <button id="fullscreenButton" title="Pantalla Completa"><i class="fas fa-expand"></i></button>
    </div>

    <div class="volume-control-group">
      <i class="fas fa-volume-down"></i> <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.7">
      <i class="fas fa-volume-up"></i> </div>
  </div>

  <audio id="audio" src="https://stream.zeno.fm/udgoxuccigfuv" crossorigin="anonymous" controls hidden></audio>

  <div class="social-links">
    <a href="https://linktr.ee/tmradio.cl" target="_blank" aria-label="Web Linktree">
      <i class="fas fa-link"></i>
    </a>
    <a href="https://www.instagram.com/totalmusicradio.cl/" target="_blank" aria-label="Instagram">
      <i class="fab fa-instagram"></i>
    </a>
    <a href="https://www.facebook.com/profile.php?id=61556476971552" target="_blank" aria-label="Facebook">
      <i class="fab fa-facebook"></i>
    </a>
    <a href="https://chat.whatsapp.com/EtQV0kcISR7IAYA6BhlGwb" target="_blank" aria-label="WhatsApp Community">
      <i class="fab fa-whatsapp"></i>
    </a>
    <a href="https://ko-fi.com/tmradio" target="_blank" aria-label="Donate a Coffee on Ko-fi">
      <i class="fas fa-coffee"></i>
    </a>
  </div>

  <script>
    const trackInfo = document.getElementById('trackInfo');
    const playButton = document.getElementById('playButton');
    const stopButton = document.getElementById('stopButton');
    const volumeControl = document.getElementById('volumeControl');
    const refreshButton = document.getElementById('refreshButton');
    const fullscreenButton = document.getElementById('fullscreenButton');
    const audio = document.getElementById('audio');
    const radioLogo = document.getElementById('radioLogo');
    const initialMessage = document.getElementById('initialMessage');

    let audioCtx = null;
    let source, analyser, dataArray;
    let renderer, scene, camera, stars, starGeo; // Three.js variables
    let audioInitialized = false;
    let fetchIntervalId;

    // --- Three.js Starfield Animation ---
    function initThreeJS() {
      const container = document.getElementById('starfield-container');
      
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
      camera.position.z = 1;
      camera.rotation.x = Math.PI / 2;

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);

      starGeo = new THREE.BufferGeometry();
      const vertices = [];
      for (let i = 0; i < 6000; i++) {
        vertices.push(
          Math.random() * 600 - 300,
          Math.random() * 600 - 300,
          Math.random() * 600 - 300
        );
      }
      starGeo.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

      // Asegúrate de que esta URL para 'star.png' sea correcta y accesible en tu repositorio
      const sprite = new THREE.TextureLoader().load('https://raw.githubusercontent.com/alphakernnel/web_tmr/main/star.png'); 
      const starMaterial = new THREE.PointsMaterial({
        color: 0xaaaaaa,
        size: 0.7,
        map: sprite,
        transparent: true
      });

      stars = new THREE.Points(starGeo, starMaterial);
      scene.add(stars);

      window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animateStars() {
      requestAnimationFrame(animateStars);

      if (stars && starGeo && stars.geometry.attributes.position) {
        const positions = stars.geometry.attributes.position.array;
        for (let i = 0; i < positions.length; i += 3) {
          positions[i + 1] -= 0.5; // Mover hacia abajo (simulando movimiento hacia adelante)
          if (positions[i + 1] < -300) {
            positions[i + 1] = 300; // Reiniciar en la parte superior
          }
        }
        stars.geometry.attributes.position.needsUpdate = true; // Indicar a Three.js que actualice los vértices
      }

      // Brillo de estrellas reacciona al audio si está inicializado y sonando
      if (audioInitialized && audio.paused === false && analyser && dataArray) {
          analyser.getByteFrequencyData(dataArray);
          let sum = dataArray.reduce((a, b) => a + b, 0);
          let avg = sum / dataArray.length;
          // Mapear el promedio a un rango de brillo (0.7 a 1.5)
          stars.material.color.setScalar(0.7 + (avg / 255) * 0.8); 
      } else {
          stars.material.color.setScalar(0.7); // Brillo base cuando no hay audio o está pausado
      }

      renderer.render(scene, camera);
    }
    // --- Fin Three.js Starfield Animation ---


    function initAudio() {
      if (!audioCtx || audioCtx.state === 'closed') {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        source = audioCtx.createMediaElementSource(audio);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
      }

      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          console.log('AudioContext reanudado.');
          playAudioAndSetup();
        }).catch(e => console.error("Error al reanudar AudioContext:", e));
      } else {
        playAudioAndSetup();
      }
    }

    function playAudioAndSetup() {
        audio.play().then(() => {
            console.log("Audio reproduciéndose. AudioContext state:", audioCtx.state);
            audioInitialized = true;
            playButton.style.display = 'none'; // Oculta Play
            stopButton.style.display = 'inline-block'; // Muestra Stop

            radioLogo.classList.add('playing'); // Iniciar pulsación del logo
            trackInfo.style.display = 'block'; // Mostrar info de la canción
            initialMessage.style.display = 'none'; // Ocultar el mensaje inicial

            fetchNowPlaying();
            if (fetchIntervalId) clearInterval(fetchIntervalId);
            fetchIntervalId = setInterval(fetchNowPlaying, 10000); // Actualizar cada 10 segundos
        }).catch(e => {
            console.error("Error al reproducir audio:", e);
            trackInfo.textContent = 'Error al iniciar la radio (requiere interacción).';
            trackInfo.style.display = 'block';
            playButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
        });
    }

    function stopAudio() {
      audio.pause();
      audio.currentTime = 0;
      trackInfo.textContent = 'Radio Detenida';
      playButton.style.display = 'inline-block'; // Muestra Play
      stopButton.style.display = 'none'; // Oculta Stop
      audioInitialized = false;
      if (fetchIntervalId) {
          clearInterval(fetchIntervalId);
          fetchIntervalId = null;
      }
      trackInfo.style.display = 'block';
      radioLogo.classList.remove('playing'); // Detener pulsación del logo

      if (audioCtx && audioCtx.state === 'running') {
          audioCtx.suspend().then(() => console.log('AudioContext suspendido.'));
      }
    }

    function setVolume(value) {
      audio.volume = value;
    }

    function togglePlayPause() {
        if (audio.paused) {
            initAudio();
        } else {
            stopAudio();
        }
    }

    function refreshPage() {
        location.reload();
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Error al intentar activar pantalla completa: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    async function fetchNowPlaying() {
      try {
        const response = await fetch('https://stream.zeno.fm/udgoxuccigfuv/nowplaying');
        if (!response.ok) throw new Error('Sin respuesta del stream.');
        const data = await response.json();
        const title = data?.title || 'Título Desconocido';
        const artist = data?.artist || 'Artista Desconocido';
        trackInfo.textContent = artist ? `${artist} - ${title}` : title;
        document.title = artist ? `${artist} - ${title} | Total Music Radio` : `${title} | Total Music Radio`;
      } catch (e) {
        console.error("Error al obtener información de la canción:", e);
        trackInfo.textContent = 'Conectando a la Radio...';
        document.title = 'Total Music Radio';
      }
    }

    // Inicializar listeners
    playButton.addEventListener('click', initAudio);
    stopButton.addEventListener('click', stopAudio);
    volumeControl.addEventListener('input', (e) => setVolume(e.target.value));
    refreshButton.addEventListener('click', refreshPage);
    fullscreenButton.addEventListener('click', toggleFullscreen);

    // Listener para el logo como Play/Pause
    radioLogo.addEventListener('click', function() {
        if (audioInitialized) {
            togglePlayPause();
        } else {
            initAudio();
        }
    });

    // Cargar info de la canción al inicio y configurar Three.js
    window.onload = function() {
        fetchNowPlaying();
        initialMessage.style.display = 'block'; // Asegurar que el mensaje inicial esté visible
        trackInfo.style.display = 'none'; // Asegurar que la info de la canción no se muestre al inicio
        
        // Iniciar Three.js al cargar la página
        initThreeJS();
        animateStars();
    };
  </script>
</body>
</html>