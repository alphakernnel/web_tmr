<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Total Music Radio (PC)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.158.0/three.min.js"></script>
  <style>
    /* Fuentes para un estilo rock/metal moderno */
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden; /* Esto oculta el scroll de la página */
      background: #121212; /* Fondo negro intenso */
      color: #f44336; /* Rojo intenso como color primario */
      font-family: 'Montserrat', sans-serif; /* Fuente moderna y legible para el cuerpo */
    }

    /* Estilos para el contenedor de estrellas (fondo) */
    #starfield-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1; /* Asegura que esté en el fondo */
      opacity: 0.8; /* Ligeramente transparente */
    }

    /* Estilos para el logo de la radio */
    #radioLogo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%); /* Centra el logo */
      max-width: 300px; /* Tamaño máximo del logo */
      height: auto;
      z-index: 1; /* Asegura que esté sobre las estrellas y detrás de la UI principal */
      filter: drop-shadow(0 0 10px rgba(255, 152, 0, 0.7)); /* Sombra para dar un efecto de brillo */
      cursor: pointer; /* Indica que es interactivo */
      transition: transform 0.2s ease-out, filter 0.3s ease; /* Transición suave para efectos hover */
    }

    #radioLogo.playing {
      animation: pulseLogo 1.5s infinite alternate; /* Animación de pulsación cuando está reproduciendo */
    }

    @keyframes pulseLogo {
        from { transform: translate(-50%, -50%) scale(1); filter: drop-shadow(0 0 10px rgba(255, 152, 0, 0.7)); }
        to { transform: translate(-50%, -50%) scale(1.05); filter: drop-shadow(0 0 20px rgba(255, 152, 0, 1)); }
    }

    /* Estilo para el mensaje de estado (Radio Detenida) */
    #radioStatusMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translateY(100px); /* Debajo del logo */
      background-color: rgba(0, 0, 0, 0.7); /* Fondo semi-transparente */
      border: 1px solid #ff9800; /* Borde naranja */
      box-shadow: 0 0 15px rgba(255, 152, 0, 0.7); /* Sombra naranja brillante */
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.2em;
      text-align: center;
      min-width: 300px;
      max-width: 80%;
      box-sizing: border-box;
      z-index: 2; /* Asegurar que esté por encima de casi todo */
      color: #fff;
      text-shadow: 0 0 5px #ff9800; /* Sombra de texto para resaltar */
      font-family: 'Montserrat', sans-serif;
    }

    .bottom-ui {
      position: absolute;
      bottom: 80px; /* Ajustado para dejar espacio a las redes sociales */
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px; /* Espacio entre los grupos de elementos */
      z-index: 2;
      width: 90%;
      box-sizing: border-box;
    }

    .controls {
      display: flex;
      gap: 20px; /* Espacio entre los botones */
      flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas pequeñas */
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.7); /* Fondo semi-transparente para la botonera */
      padding: 15px 30px;
      border-radius: 12px;
      border: 1px solid #616161;
      box-shadow: 0 0 15px rgba(97, 97, 97, 0.4);
    }

    .controls button {
      padding: 12px 25px;
      font-size: 1.2em;
      background-color: #f44336;
      color: #fff;
      border: 2px solid #d32f2f;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Roboto Condensed', sans-serif;
      font-weight: 700;
      box-shadow: 0 0 8px rgba(244, 67, 54, 0.6);
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
      flex-shrink: 0; /* Evita que los botones se encojan en pantallas pequeñas */
    }

    .controls button:hover {
      background-color: #d32f2f;
      box-shadow: 0 0 15px rgba(211, 47, 47, 0.8);
      transform: translateY(-2px); /* Pequeño efecto al pasar el ratón */
    }

    /* Estilo específico para el botón de refrescar y pantalla completa */
    .controls #refreshButton,
    .controls #fullscreenButton {
      font-size: 1em; /* Ligeramente más pequeños */
      padding: 10px 20px;
    }

    /* Estilos para el control de volumen */
    .volume-control-group {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid #616161;
      box-shadow: 0 0 10px rgba(97, 97, 97, 0.4);
      margin-top: 15px; /* Separación de los botones de control */
    }

    .volume-control-group i {
      color: #fff;
      font-size: 1.5em; /* Tamaño del icono de volumen */
      text-shadow: 0 0 5px #ff9800;
    }

    #volumeControl {
      width: 150px;
      -webkit-appearance: none; /* Elimina estilos por defecto del navegador */
      appearance: none;
      height: 8px;
      background: #555; /* Fondo del deslizador */
      outline: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #volumeControl::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #ff9800; /* Naranja brillante para el thumb */
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(255, 152, 0, 0.8); /* Sombra para el thumb */
    }

    #volumeControl::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #ff9800;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(255, 152, 0, 0.8);
    }

    /* Estilos para las redes sociales */
    .social-links {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 3;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid #616161;
      box-shadow: 0 0 10px rgba(97, 97, 97, 0.4);
    }

    .social-links a {
      color: #fff;
      font-size: 1.5em;
      transition: color 0.3s, transform 0.3s;
      text-decoration: none;
    }

    .social-links a:hover {
      color: #ff9800;
      transform: scale(1.2);
    }

    /* Estilos específicos para algunos iconos con sus colores de marca */
    .social-links .fa-instagram:hover { color: #E1306C; }
    .social-links .fa-facebook:hover { color: #3b5998; }
    .social-links .fa-whatsapp:hover { color: #25D366; }
    .social-links .fa-coffee:hover { color: #FFDD00; }
  </style>
</head>
<body>
  <div id="starfield-container"></div>

  <img id="radioLogo" src="https://github.com/alphakernnel/web_tmr/blob/main/logo_tmr.png?raw=true" alt="Logo Total Music Radio">

  <div id="radioStatusMessage" style="display:none;"></div>

  <div class="bottom-ui">
    <div class="controls" id="controlPanel">
      <button id="playButton"><i class="fas fa-play"></i></button>
      <button id="stopButton" style="display:none"><i class="fas fa-stop"></i></button>

      <button id="refreshButton" title="Recargar la conexión"><i class="fas fa-sync-alt"></i></button>
      <button id="fullscreenButton" title="Pantalla Completa"><i class="fas fa-expand"></i></button>
    </div>

    <div class="volume-control-group">
      <i class="fas fa-volume-down"></i> <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.7">
      <i class="fas fa-volume-up"></i> </div>
  </div>

  <audio id="audio" src="https://stream.zeno.fm/udgoxuccigfuv" crossorigin="anonymous" controls hidden></audio>

  <div class="social-links">
    <a href="https://linktr.ee/tmradio.cl" target="_blank" aria-label="Web Linktree">
      <i class="fas fa-link"></i>
    </a>
    <a href="https://www.instagram.com/totalmusicradio.cl/" target="_blank" aria-label="Instagram">
      <i class="fab fa-instagram"></i>
    </a>
    <a href="https://www.facebook.com/profile.php?id=61556476971552" target="_blank" aria-label="Facebook">
      <i class="fab fa-facebook"></i>
    </a>
    <a href="https://chat.whatsapp.com/EtQV0kcISR7IAYA6BhlGwb" target="_blank" aria-label="WhatsApp Community">
      <i class="fab fa-whatsapp"></i>
    </a>
    <a href="https://ko-fi.com/tmradio" target="_blank" aria-label="Donate a Coffee on Ko-fi">
      <i class="fas fa-coffee"></i>
    </a>
  </div>

  <script>
    const radioStatusMessage = document.getElementById('radioStatusMessage');
    const playButton = document.getElementById('playButton');
    const stopButton = document.getElementById('stopButton');
    const volumeControl = document.getElementById('volumeControl');
    const refreshButton = document.getElementById('refreshButton');
    const fullscreenButton = document.getElementById('fullscreenButton');
    const audio = document.getElementById('audio');
    const radioLogo = document.getElementById('radioLogo');

    let audioCtx = null;
    let source, analyser, dataArray;
    let renderer, scene, camera, stars, starGeo;
    let audioInitialized = false; // Bandera para saber si el AudioContext ha sido inicializado/reanudado

    // --- Three.js Starfield Animation ---
    function initThreeJS() {
      console.log('initThreeJS: Intentando inicializar Three.js');
      if (typeof THREE === 'undefined') {
        console.error('initThreeJS: ERROR - THREE.js no está cargado. Asegúrate de que el script src sea correcto y esté accesible.');
        return;
      }

      const container = document.getElementById('starfield-container');
      if (!container) {
        console.error('initThreeJS: ERROR - Contenedor #starfield-container no encontrado.');
        return;
      }
      // Limpiar el contenedor por si acaso hay un renderizador anterior (útil si se llama varias veces)
      while (container.firstChild) {
          container.removeChild(container.firstChild);
      }

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
      camera.position.z = 1;
      camera.rotation.x = Math.PI / 2; // Para que las estrellas "caigan" hacia la cámara

      try {
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // alpha: true permite fondo transparente del canvas
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        console.log('initThreeJS: Renderer y cámara inicializados.');
      } catch (e) {
        console.error('initThreeJS: ERROR al crear o añadir el renderer de Three.js:', e);
        return;
      }

      starGeo = new THREE.BufferGeometry();
      const vertices = [];
      const starCount = 6000; // Número de estrellas
      for (let i = 0; i < starCount; i++) {
        vertices.push(
          Math.random() * 600 - 300, // x
          Math.random() * 600 - 300, // y
          Math.random() * 600 - 300  // z
        );
      }
      starGeo.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
      console.log(`initThreeJS: ${starCount} estrellas generadas.`);

      // Carga la textura para las estrellas
      const starTextureLoader = new THREE.TextureLoader();
      starTextureLoader.load('https://raw.githubusercontent.com/alphakernnel/web_tmr/main/star.png',
        function(sprite) {
          const starMaterial = new THREE.PointsMaterial({
            color: 0xaaaaaa, // Color blanco-grisáceo para las estrellas
            size: 0.7, // Tamaño de las estrellas
            map: sprite, // Aplica la textura
            transparent: true,
            blending: THREE.AdditiveBlending // Para un efecto de brillo
          });
          stars = new THREE.Points(starGeo, starMaterial);
          scene.add(stars);
          console.log('initThreeJS: Estrellas con textura añadidas a la escena.');
        },
        undefined, // Función onProgress
        function(err) {
          console.error('initThreeJS: ERROR al cargar la textura de estrella. Usando material básico.', err);
          // Fallback a un material sin textura si la carga falla
          const starMaterial = new THREE.PointsMaterial({
            color: 0xaaaaaa,
            size: 0.7,
            transparent: true,
            blending: THREE.AdditiveBlending
          });
          stars = new THREE.Points(starGeo, starMaterial);
          scene.add(stars);
        }
      );

      window.addEventListener('resize', onWindowResize, false);
      console.log('initThreeJS: Listener de redimensionamiento añadido.');
    }

    function onWindowResize() {
      if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    }

    function animateStars() {
      requestAnimationFrame(animateStars);

      if (stars && starGeo && stars.geometry.attributes.position) {
        const positions = stars.geometry.attributes.position.array;
        // Mueve las estrellas hacia abajo para simular movimiento
        for (let i = 0; i < positions.length; i += 3) {
          positions [i + 1] -= 0.5; // Ajusta la velocidad de movimiento
          if (positions [i + 1] < -300) { // Si una estrella se sale de la vista, la reposiciona arriba
            positions [i + 1] = 300;
          }
        }
        stars.geometry.attributes.position.needsUpdate = true; // Notifica a Three.js que los vértices han cambiado
      }

      // Reacciona al audio (si está reproduciéndose)
      if (audioInitialized && audio.paused === false && analyser && dataArray) {
          analyser.getByteFrequencyData(dataArray); // Obtiene datos de frecuencia
          let sum = dataArray.reduce((a, b) => a + b, 0);
          let avg = sum / dataArray.length; // Calcula el promedio de las frecuencias

          // Ajusta el color de las estrellas basado en el volumen/energía del audio
          if (stars && stars.material) {
            stars.material.color.setScalar(0.7 + (avg / 255) * 0.8); // Escala el color
          }
      } else {
          // Si la radio no está sonando, las estrellas mantienen un color base
          if (stars && stars.material) {
            stars.material.color.setScalar(0.7);
          }
      }

      if (renderer && scene && camera) {
        renderer.render(scene, camera);
      }
    }
    // --- Fin Three.js Starfield Animation ---


    function initAudio() {
      console.log('initAudio: Iniciando o reanudando AudioContext.');
      // Asegurarse de que AudioContext se inicialice por interacción del usuario
      if (!audioCtx || audioCtx.state === 'closed') {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        source = audioCtx.createMediaElementSource(audio);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256; // Tamaño FFT, afecta la granularidad del análisis de frecuencia
        dataArray = new Uint8Array(analyser.frequencyBinCount); // Array para almacenar los datos de frecuencia
        source.connect(analyser); // Conecta la fuente de audio al analizador
        analyser.connect(audioCtx.destination); // Conecta el analizador al destino (salida de audio)
        console.log('initAudio: AudioContext y nodos creados.');
      }

      // Si el AudioContext está suspendido (común en Chrome por autoplay policies), reanudarlo
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          console.log('AudioContext reanudado.');
          playAudioAndSetup();
        }).catch(e => console.error("Error al reanudar AudioContext:", e));
      } else {
        playAudioAndSetup();
      }
    }

    function playAudioAndSetup() {
        audio.play().then(() => {
            console.log("playAudioAndSetup: Audio reproduciéndose. AudioContext state:", audioCtx.state);
            audioInitialized = true; // Marca que el audio está inicializado y reproduciéndose
            playButton.style.display = 'none';
            stopButton.style.display = 'inline-block';

            radioLogo.classList.add('playing'); // Agrega clase para la animación del logo

            radioStatusMessage.style.display = 'none'; // Oculta el mensaje de estado
            radioStatusMessage.textContent = ''; // Limpia el texto del mensaje
        }).catch(e => {
            console.error("playAudioAndSetup: Error al reproducir audio:", e);
            radioStatusMessage.textContent = 'Error al iniciar la radio (requiere interacción).';
            radioStatusMessage.style.display = 'block';
            playButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
        });
    }

    function stopAudio() {
      console.log('stopAudio: Deteniendo audio.');
      audio.pause();
      audio.currentTime = 0; // Reinicia el audio
      radioStatusMessage.textContent = 'Radio Detenida';
      radioStatusMessage.style.display = 'block';
      playButton.style.display = 'inline-block';
      stopButton.style.display = 'none';
      audioInitialized = false; // Reinicia la bandera
      radioLogo.classList.remove('playing'); // Quita la animación del logo

      // Suspender AudioContext para liberar recursos si no se usa
      if (audioCtx && audioCtx.state === 'running') {
          audioCtx.suspend().then(() => console.log('AudioContext suspendido.'));
      }
    }

    function setVolume(value) {
      audio.volume = value;
      console.log('Volumen ajustado a:', value);
    }

    function togglePlayPause() {
        if (audio.paused) {
            initAudio();
        } else {
            stopAudio();
        }
    }

    function refreshPage() {
        console.log('Recargando página.');
        location.reload(); // Recarga la página por completo
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) { // Si no está en pantalla completa
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Error al intentar activar pantalla completa: ${err.message} (${err.name})`);
            });
        } else { // Si ya está en pantalla completa
            document.exitFullscreen();
        }
    }

    // Inicializar listeners al cargar el DOM
    document.addEventListener('DOMContentLoaded', (event) => {
        console.log('DOMContentLoaded: DOM completamente cargado.');
        radioStatusMessage.style.display = 'none'; // Asegurarse de que el mensaje de estado esté oculto al inicio

        playButton.style.display = 'inline-block'; // Mostrar botón de Play
        stopButton.style.display = 'none'; // Ocultar botón de Stop

        // Asigna eventos a los botones y slider
        playButton.addEventListener('click', initAudio);
        stopButton.addEventListener('click', stopAudio);
        volumeControl.addEventListener('input', (e) => setVolume(e.target.value));
        refreshButton.addEventListener('click', refreshPage);
        fullscreenButton.addEventListener('click', toggleFullscreen);

        // Listener para el logo como Play/Pause
        radioLogo.addEventListener('click', function() {
            // Si el audio ya ha sido inicializado (es decir, el usuario ya interactuó)
            if (audioInitialized) {
                togglePlayPause();
            } else {
                // Si es la primera interacción, inicializa el audio
                initAudio();
            }
        });

        // Inicializa Three.js y la animación de estrellas
        initThreeJS();
        animateStars();
        console.log('DOMContentLoaded: Three.js y animación de estrellas inicializados.');
    });
  </script>
</body>
</html>